{% extends "base.html" %}
{% block title %}Dashboard - Tiger Marketing CRM{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Tiger Marketing Overview{% endblock %}

{% block content %}
{% if error %}
<div class="flash error">{{ error }}</div>
{% endif %}

<!-- Key Metrics -->
<div class="stats-grid">
    <div class="stat-card accent">
        <div class="label">Total Contacts</div>
        <div class="value">{{ total_contacts or 0 }}</div>
        <div class="change text-accent">{{ new_leads or 0 }} new leads</div>
    </div>
    <div class="stat-card green">
        <div class="label">Active Deals</div>
        <div class="value">{{ active_deals or 0 }}</div>
    </div>
    <div class="stat-card yellow">
        <div class="label">Pipeline Value</div>
        <div class="value money">{{ "{:,.0f}".format(pipeline_value or 0) }}</div>
    </div>
    <div class="stat-card green">
        <div class="label">Won Revenue</div>
        <div class="value money">{{ "{:,.0f}".format(won_revenue or 0) }}</div>
        <div class="change text-green">{{ won_deals or 0 }} deals won</div>
    </div>
    <div class="stat-card orange">
        <div class="label">Open Tasks</div>
        <div class="value">{{ open_tasks or 0 }}</div>
        {% if overdue_tasks %}<div class="change text-red">{{ overdue_tasks }} overdue</div>{% endif %}
    </div>
    <div class="stat-card purple">
        <div class="label">Active Campaigns</div>
        <div class="value">{{ active_campaigns or 0 }}</div>
    </div>
</div>

<div class="two-col">
    <!-- Recent Contacts -->
    <div class="card">
        <div class="card-header">
            <h3>Recent Contacts</h3>
            <a href="{{ url_for('contacts_list') }}" class="btn btn-sm btn-secondary">View All</a>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Phone</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in recent_contacts %}
                    <tr>
                        <td><a href="{{ url_for('contact_detail', contact_id=c.CONTACT_ID) }}">{{ c.FIRST_NAME }} {{ c.LAST_NAME }}</a></td>
                        <td>
                            {% if c.LEAD_STATUS %}
                            <span class="badge badge-{{ c.LEAD_STATUS|lower|replace(' ', '') }}">{{ c.LEAD_STATUS }}</span>
                            {% endif %}
                        </td>
                        <td class="text-muted">{{ c.PHONE or '-' }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted">No contacts yet</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Upcoming Tasks -->
    <div class="card">
        <div class="card-header">
            <h3>Upcoming Tasks</h3>
            <a href="{{ url_for('tasks_list') }}" class="btn btn-sm btn-secondary">View All</a>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Contact</th>
                        <th>Due</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in upcoming_tasks %}
                    <tr>
                        <td>{{ t.DESCRIPTION|truncate(40) }}</td>
                        <td class="text-muted">{{ t.CONTACT_NAME or '-' }}</td>
                        <td>
                            {% if t.DUE_DATE %}
                            <span class="{% if t.DUE_DATE < now().isoformat()[:10] %}text-red{% endif %}">{{ t.DUE_DATE }}</span>
                            {% else %}-{% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted">No pending tasks</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pipeline & Recent Deals -->
<div class="two-col mt-4">
    <!-- Pipeline by Stage -->
    <div class="card">
        <div class="card-header">
            <h3>Pipeline by Stage</h3>
        </div>
        <div class="card-body">
            {% for s in pipeline_stages %}
            <div class="flex items-center justify-between" style="padding: 10px 0; border-bottom: 1px solid var(--border);">
                <div>
                    <span class="badge badge-{{ s.STAGE|lower|replace(' ', '') }}">{{ s.STAGE }}</span>
                    <span class="text-muted" style="margin-left: 8px;">{{ s.CNT }} deals</span>
                </div>
                <div style="font-weight: 700; color: var(--green);">${{ "{:,.0f}".format(s.TOTAL) }}</div>
            </div>
            {% else %}
            <div class="text-center text-muted" style="padding: 30px;">No active pipeline</div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Deals -->
    <div class="card">
        <div class="card-header">
            <h3>Recent Deals</h3>
            <a href="{{ url_for('deals_list') }}" class="btn btn-sm btn-secondary">View All</a>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Deal</th>
                        <th>Stage</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in recent_deals %}
                    <tr>
                        <td>
                            {{ d.DEAL_NAME }}
                            {% if d.CONTACT_NAME %}<br><span class="text-muted" style="font-size:12px">{{ d.CONTACT_NAME }}</span>{% endif %}
                        </td>
                        <td><span class="badge badge-{{ d.STAGE|lower|replace(' ', '') }}">{{ d.STAGE }}</span></td>
                        <td style="font-weight:700">${{ "{:,.0f}".format(d.AMOUNT or 0) }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center text-muted">No deals yet</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Leads by Status -->
<div class="card mt-4">
    <div class="card-header">
        <h3>Leads by Status</h3>
    </div>
    <div class="card-body">
        <div class="flex gap-2" style="flex-wrap: wrap;">
            {% for l in leads_by_status %}
            <div style="background: var(--bg-input); padding: 12px 20px; border-radius: 8px; text-align: center; min-width: 120px;">
                <div style="font-size: 24px; font-weight: 700;">{{ l.CNT }}</div>
                <div class="text-muted" style="font-size: 12px; text-transform: uppercase;">{{ l.LEAD_STATUS or 'Unknown' }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
